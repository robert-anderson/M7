#INFO: **** input file is /home/anderson/CLionProjects/M7/assets/HF_RDMs/rdm.py ****
from pyscf import M, mrpt, mcscf, scf, fci, symm, tools
import sys, os, h5py
sys.path.append(os.path.abspath('.'))
import numpy as np
from functools import reduce

d = {
    'mol_kwargs': {
        'atom':
        '''
        H 0.000000 0.000000 0.000000
        F 0.000000 0.000000 1.4
        ''',
        'basis': {'H': 'cc-pvdz', 'F': 'cc-pvdz'},
        'symmetry': True,
        'symmetry_subgroup': 'C2v',
        'verbose': 4,
        'charge': 0,
        'spin': 0
        }
    }

def fcidump(mc, mol, filename='FCIDUMP.new'):
    IRREP_MAP = {
        'D2h': (1, 4, 6, 7, 8, 5, 3, 2),
        'C2v': (1, 4, 2, 3),
        'C2h': (1, 4, 2, 3),
        'D2' : (1, 4, 3, 2),
        'Cs' : (1, 2),
        'C2' : (1, 2),
        'Ci' : (1, 2),
        'C1' : (1,)
    }
    eri_cas = mc.get_h2eff(mc.mo_coeff)
    h1eff, energy_core = mc.get_h1eff(mc.mo_coeff)
    orbsym = symm.label_orb_symm(mol, mol.irrep_name, mol.symm_orb, mc.mo_coeff)
    orbsym = [symm.param.IRREP_ID_TABLE[mol.groupname][i] for i in orbsym]
    orbsym = [IRREP_MAP[mol.groupname][i] for i in orbsym]
    orbsym = orbsym[mc.ncore:mc.ncore+h1eff.shape[0]]
    tools.fcidump.from_integrals(filename, h1eff, eri_cas, h1eff.shape[0], mc.nelecas, energy_core, mol.ms, orbsym)

'''
output Fock matrix in Molcas HDF5 format
'''
def fockdump(fock, fname):
    inds = []
    values = []
    for i in range(fock.shape[0]):
        for j in range(0, i+1):
            if fock[i, j]:
                inds.append((i+1, j+1))
                values.append(fock[i,j])
    inds = np.array(inds)
    values = np.array(values)

    f = h5py.File(fname, 'w')
    f['ACT_FOCK_INDEX'] = inds
    f['ACT_FOCK_VALUES'] = values

nelecas = 6
ncas = 5

mol = M(**d['mol_kwargs'])
nelecb = (nelecas-mol.spin)//2
neleca = nelecas - nelecb

myhf = scf.ROHF(mol)
myhf.kernel()
myhf.analyze()

mc = mcscf.CASCI(myhf, ncas, nelecas)
mc.kernel()

ao_rdm = mc.make_rdm1()[mc.ncore:mc.ncore+ncas, mc.ncore:mc.ncore+ncas]
mo_rdm = mc.fcisolver.make_rdm1(mc.fcisolver.ci, ncas, nelecas)

fock_ao = mc.get_fock(mc.mo_coeff, mc.fcisolver.ci, mc.get_h2eff(mc.mo_coeff), mo_rdm)
fock_mo = reduce(np.dot, (mc.mo_coeff.T, fock_ao, mc.mo_coeff))
cas_fock_mo = fock_mo[mc.ncore:mc.ncore+ncas, mc.ncore:mc.ncore+ncas]

dm1, dm2, dm3, dm4 = fci.rdm.make_dm1234('FCI4pdm_kern_sf', mc.fcisolver.ci, mc.fcisolver.ci, ncas, (neleca, nelecb))
dm1, dm2, dm3, dm4 = fci.rdm.reorder_dm1234(dm1, dm2, dm3, dm4)
dm4f = np.einsum('iajbkcld,ld->iajbkc', dm4, cas_fock_mo)
dm4fd = np.einsum('iajbkcll,ll->iajbkc', dm4, cas_fock_mo)

assert ao_rdm.shape==mo_rdm.shape

fcidump(mc, mol, 'FCIDUMP')
fockdump(cas_fock_mo, 'fock.h5')
fockdump(np.diag(cas_fock_mo.diagonal()), 'fock_diag.h5')

# transpose higher-rank arrays such that the creation inds are first, then the annihilations
dms = {
    'sf_1100' : np.array(dm1),
    'sf_2200' : np.array(dm2).transpose(0, 2, 1, 3),
    'sf_3300' : np.array(dm3).transpose(0, 2, 4, 1, 3, 5),
    'sf_4400f': np.array(dm4f).transpose(0, 2, 4, 1, 3, 5),
    'sf_4400fd': np.array(dm4fd).transpose(0, 2, 4, 1, 3, 5),
}

import pickle as pkl
with open('exact_rdms.pkl', 'wb') as f: pkl.dump(dms, f)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='pcal011', release='5.3.18-lp152.106-default', version='#1 SMP Mon Nov 22 08:38:17 UTC 2021 (52078fe)', machine='x86_64', processor='x86_64')  Threads 8
Python 3.6.12 (default, Dec 02 2020, 09:44:23) [GCC]
numpy 1.19.5  scipy 1.5.4
Date: Thu Nov  3 10:50:55 2022
PySCF version 2.0.1
PySCF path  /scratch/anderson/opt/pyscf-2.0.1/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry True subgroup C2v
[INPUT] Mole.unit = angstrom
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 F      0.000000000000   0.000000000000   1.400000000000 AA    0.000000000000   0.000000000000   2.645616574391 Bohr

nuclear repulsion = 3.40185349877143
point group symmetry = Coov, use subgroup C2v
num. orbitals of irrep A1 = 10
num. orbitals of irrep A2 = 1
num. orbitals of irrep B1 = 4
num. orbitals of irrep B2 = 4
number of shells = 8
number of NR pGTOs = 33
number of NR cGTOs = 19
basis = {'H': 'cc-pvdz', 'F': 'cc-pvdz'}
ecp = {}
CPU time:         0.39


******** <class 'pyscf.scf.hf_symm.SymAdaptedROHF'> ********
method = SymAdaptedROHF-ROHF-RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /home/anderson/CLionProjects/M7/assets/HF_RDMs/tmpstivtwvb
max_memory 4000 MB (current use 84 MB)
num. doubly occ = 5  num. singly occ = 0
Freeze 0 electrons in irreps []
    10 free electrons in irreps A1 A2 B1 B2
Set gradient conv threshold to 3.16228e-05
init E= -99.4736608092962
HOMO (B2) = -0.622836761526106  LUMO (A1) = -0.0671283112376685
cycle= 1 E= -99.8167374576534  delta_E= -0.343  |g|= 0.568  |ddm|= 0.54
HOMO (B2) = -0.400219308423748  LUMO (A1) = 0.0235185423814383
cycle= 2 E= -99.8660687139547  delta_E= -0.0493  |g|= 0.481  |ddm|= 0.418
HOMO (B1) = -0.577893050897683  LUMO (A1) = 0.0201152440866858
cycle= 3 E= -99.8992273107931  delta_E= -0.0332  |g|= 0.0467  |ddm|= 0.169
HOMO (B2) = -0.588582089065227  LUMO (A1) = 0.0433746557935449
cycle= 4 E= -99.9006606814955  delta_E= -0.00143  |g|= 0.0146  |ddm|= 0.0421
HOMO (A1) = -0.589138577166339  LUMO (A1) = 0.0456183283857525
cycle= 5 E= -99.9007877828254  delta_E= -0.000127  |g|= 0.00218  |ddm|= 0.0162
HOMO (A1) = -0.588792336740396  LUMO (A1) = 0.0450098228040045
cycle= 6 E= -99.9007897297422  delta_E= -1.95e-06  |g|= 0.000387  |ddm|= 0.00206
HOMO (A1) = -0.588913354290591  LUMO (A1) = 0.045143060758908
cycle= 7 E= -99.9007897926557  delta_E= -6.29e-08  |g|= 3.14e-05  |ddm|= 0.000405
HOMO (A1) = -0.588883963052479  LUMO (A1) = 0.0451310615031435
cycle= 8 E= -99.9007897928924  delta_E= -2.37e-10  |g|= 5.33e-06  |ddm|= 1.62e-05
HOMO (A1) = -0.588887403751201  LUMO (A1) = 0.0451328406727189
Extra cycle  E= -99.9007897928981  delta_E= -5.64e-12  |g|= 1.81e-06  |ddm|= 2.98e-06
converged SCF energy = -99.9007897928981
**** SCF Summaries ****
Total Energy =                         -99.900789792898081
Nuclear Repulsion Energy =               3.401853498771429
One-electron Energy =                 -147.491624143051610
Two-electron Energy =                   44.188980851382105
Wave-function symmetry = A1
occupancy for each irrep:     A1   A2   B1   B2
double occ                     3    0    1    1
single occ                     0    0    0    0
**** MO energy ****
                          Roothaan           | alpha              | beta
MO #1   (A1  #1 ) energy= -26.2801705445606  | -26.2801705445606  | -26.2801705445606  occ= 2
MO #2   (A1  #2 ) energy= -1.49251855868617  | -1.49251855868617  | -1.49251855868617  occ= 2
MO #3   (B1  #1 ) energy= -0.59763074721533  | -0.59763074721533  | -0.59763074721533  occ= 2
MO #4   (B2  #1 ) energy= -0.597630747215331 | -0.597630747215331 | -0.597630747215331 occ= 2
MO #5   (A1  #3 ) energy= -0.588887403751201 | -0.588887403751202 | -0.588887403751202 occ= 2
MO #6   (A1  #4 ) energy= 0.0451328406727189 | 0.0451328406727207 | 0.0451328406727207 occ= 0
MO #7   (A1  #5 ) energy= 0.585884083939445  | 0.585884083939443  | 0.585884083939443  occ= 0
MO #8   (B1  #2 ) energy= 1.31425679099996   | 1.31425679099996   | 1.31425679099996   occ= 0
MO #9   (B2  #2 ) energy= 1.31425679099995   | 1.31425679099995   | 1.31425679099995   occ= 0
MO #10  (A1  #6 ) energy= 1.56743306088792   | 1.56743306088791   | 1.56743306088791   occ= 0
MO #11  (A1  #7 ) energy= 1.60737055187225   | 1.60737055187225   | 1.60737055187225   occ= 0
MO #12  (B1  #3 ) energy= 1.6163482071078    | 1.6163482071078    | 1.6163482071078    occ= 0
MO #13  (B2  #3 ) energy= 1.6163482071078    | 1.6163482071078    | 1.6163482071078    occ= 0
MO #14  (A1  #8 ) energy= 2.30051769941309   | 2.30051769941309   | 2.30051769941309   occ= 0
MO #15  (A1  #9 ) energy= 4.03722626034272   | 4.03722626034272   | 4.03722626034272   occ= 0
MO #16  (A2  #1 ) energy= 4.03722626034271   | 4.03722626034271   | 4.03722626034271   occ= 0
MO #17  (B1  #4 ) energy= 4.04590855836415   | 4.04590855836415   | 4.04590855836415   occ= 0
MO #18  (B2  #4 ) energy= 4.04590855836415   | 4.04590855836415   | 4.04590855836415   occ= 0
MO #19  (A1  #10) energy= 4.33267983139734   | 4.33267983139734   | 4.33267983139734   occ= 0
 ** Mulliken pop on meta-lowdin orthogonal AOs  **
 ** Mulliken pop  **
pop of  0 H 1s        0.61296
pop of  0 H 2s        0.00012
pop of  0 H 2px       0.00052
pop of  0 H 2py       0.00052
pop of  0 H 2pz       0.00177
pop of  1 F 1s        2.00000
pop of  1 F 2s        1.95799
pop of  1 F 3s        0.00027
pop of  1 F 2px       1.99904
pop of  1 F 2py       1.99904
pop of  1 F 2pz       1.42552
pop of  1 F 3px       0.00035
pop of  1 F 3py       0.00035
pop of  1 F 3pz       0.00087
pop of  1 F 3dxy      0.00000
pop of  1 F 3dyz      0.00010
pop of  1 F 3dz^2     0.00050
pop of  1 F 3dxz      0.00010
pop of  1 F 3dx2-y2    0.00000
 ** Mulliken atomic charges  **
charge of  0H =      0.38411
charge of  1F =     -0.38411
Dipole moment(X, Y, Z, Debye):  0.00000,  0.00000, -2.81239
Active space CI wfn symmetry = A1

******** CASCI flags ********
CAS (3e+3e, 5o), ncore = 2, nvir = 12
natorb = False
canonicalization = True
sorting_mo_energy = False
max_memory 4000 (MB)
******** <class 'pyscf.fci.direct_spin1_symm.FCISolver'> ********
max. cycles = 200
conv_tol = 1e-08
davidson only = True
linear dependence = 1e-10
level shift = 0.001
max iter space = 12
max_memory 4000 MB
nroots = 1
pspace_size = 0
spin = None
Input CI wfn symmetry = A1
Density matrix diagonal elements [1.99976515 1.99976515 1.89438488 0.09365305 0.01243177]
CASCI converged
CASCI E = -99.9421389039333  E(CI) = -14.4625646137449  S^2 = 0.0000000
